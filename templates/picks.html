{% extends "base.html" %}
{% block content %}
    <script>
	async function savePick(gameId, pick) {
		const res = await fetch("/api/save_pick", {
			method: "POST",
			headers: {
				"Content-Type": "application/json",
			},
			body: JSON.stringify({
				game_id: gameId,
				pick: pick,
			}),
		});
	}

	async function savePlayoffPick(playoffGameId, teamId) {
		await fetch("/api/save_playoff_pick", {
			method: "POST",
			headers: {
				"Content-Type": "application/json",
			},
			body: JSON.stringify({
				playoff_game_id: playoffGameId,
				team_id: teamId,
			}),
		});

		reloadPicks();
	}

	async function reloadPicks() {
		const container = document.getElementById("picks-container");

		container.style.opacity = "0.25";

		const res = await fetch("/picks", {
			headers: { "X-Requested-With": "XMLHttpRequest" },
		});

		const html = await res.text();
		container.innerHTML = html;
		container.style.opacity = "1";

		// re-run your UTC formatting and expiration lock
		document.querySelectorAll(".utc").forEach((el) => {
			const ts = new Date(el.textContent.trim());
			el.textContent = ts.toLocaleString([], {
				dateStyle: "medium",
				timeStyle: "short",
			});

			const now = new Date();
			const expired = ts < now;
			const card = el.closest(".card-body");
			card.querySelectorAll(".pick-wrapper input").forEach((input) => {
				input.disabled = expired;
			});
		});
		document.querySelectorAll(".playoff").forEach((el) => {
			const now = new Date();
			const firstCFPGame = new Date(1766192400 * 1000); // Dec 19, 8PM EST in Unix timestamp (ms)
			if (now > firstCFPGame) {
				const card = el.closest(".card-body");
				card.querySelectorAll(".pick-wrapper input").forEach(
					(input) => {
						input.disabled = true;
					}
				);
			}
		});
	}

	document.addEventListener("DOMContentLoaded", () => {
		document.querySelectorAll(".utc").forEach((el) => {
			const ts = new Date(el.textContent.trim());
			el.textContent = ts.toLocaleString([], {
				dateStyle: "medium",
				timeStyle: "short",
			});

			const now = new Date();

			const expired = ts < now;

			const card = el.closest(".card-body");
			card.querySelectorAll(".pick-wrapper input").forEach((input) => {
				input.disabled = expired;
			});
		});
		document.querySelectorAll(".playoff").forEach((el) => {
			const now = new Date();
			const firstCFPGame = new Date(1766192400 * 1000); // Dec 19, 8PM EST in Unix timestamp (ms)
			if (now > firstCFPGame) {
				const card = el.closest(".card-body");
				card.querySelectorAll(".pick-wrapper input").forEach(
					(input) => {
						input.disabled = true;
					}
				);
			}
		});
	});
    </script>
    <style>
	.pick-wrapper {
		display: grid;
		grid-template-columns: 1fr 1fr;
		gap: 1rem;
	}

	@media screen and (max-width: 576px) {
		.pick-wrapper {
			grid-template-columns: 1fr;
		}
	}

	.pick-btn {
		width: 100%;
		padding: 1rem;
		display: flex;
		align-items: center;
		justify-content: space-between; /* pushes text left, logo right */
		gap: 1rem;
		text-align: left;
	}

	.pick-btn .text-block {
		display: flex;
		flex-direction: column;
		line-height: 1.2;
	}

	.pick-btn img {
		width: 60px;
		height: 60px;
		object-fit: contain;
	}

	.favorite-hint {
		border-width: 4px;
		opacity: 0.85;
	}

    </style>
    <h1 class="mb-4">Picks</h1>
    <div id="picks-container">
        {% for game in games %}
            {% set favorite = None %}
            {% if game.line < 0 %}
                {% set favorite = game.home_team %}
            {% elif game.line > 0 %}
                {% set favorite = game.away_team %}
            {% endif %}
            <div class="card w-100 mb-4 shadow-sm">
                <div class="card-body">
                    <h4 class="card-title mb-3">{{ game.title }}</h4>
                    <h5 class="card-text utc">{{ game.start_date.isoformat() }}Z</h5>
                    <div class="pick-wrapper">
                        <!-- Home -->
                        <input type="radio" class="btn-check" name="pick_{{ game.id }}"
                            id="pick_{{ game.id }}_home" autocomplete="off" value="{{
                            game.home_team }}" {% if user_picks.get(game.id) ==
                            game.home_team %}checked{% endif %} onchange="savePick({{
                            game.id }}, '{{ game.home_team }}')" >
                            <label class="btn btn-outline-primary pick-btn {% if not user_picks.get(game.id) and favorite == game.home_team %}favorite-hint{% endif %}"
                                   for="pick_{{ game.id }}_home">
                                <div class="text-block">
                                    <strong>{{ game.home_team }}</strong>
                                    <span>
                                        {% if game.line > 0 %}
                                            {{ game.line }} point
                                            underdog
                                        {% else %}
                                            {{ game.line * -1 }} point
                                            favorite
                                        {% endif %}
                                    </span>
                                </div>
                                <img src="http://a.espncdn.com/i/teamlogos/ncaa/500/{{ game.home_id }}.png" />
                            </label>
                            <!-- Away -->
                            <input type="radio" class="btn-check" name="pick_{{ game.id }}"
                                id="pick_{{ game.id }}_away" autocomplete="off" value="{{
                                game.away_team }}" {% if user_picks.get(game.id) ==
                                game.away_team %}checked{% endif %} onchange="savePick({{
                                game.id }}, '{{ game.away_team }}')" >
                                <label class="btn btn-outline-primary pick-btn {% if not user_picks.get(game.id) and favorite == game.away_team %}favorite-hint{% endif %}"
                                       for="pick_{{ game.id }}_away">
                                    <div class="text-block">
                                        <strong>{{ game.away_team }}</strong>
                                        <span>
                                            {% if game.line < 0 %}
                                                {{ game.line * -1 }} point
                                                underdog
                                            {% else %}
                                                {{ game.line }} point favorite
                                            {% endif %}
                                        </span>
                                    </div>
                                    <img src="http://a.espncdn.com/i/teamlogos/ncaa/500/{{ game.away_id }}.png" />
                                </label>
                            </div>
                        </div>
                    </div>
                {% endfor %}
                <h2 class="mt-5">Playoff Picks</h2>
                {% for pg in playoff_games %}
                    <div class="card w-100 mb-4 shadow-sm">
                        <div class="card-body">
                            <h4 class="card-title mb-3">{{ pg.name }}</h4>
                            {% set t1 = bracket[pg.id]["team1"] %} {% set t2 = bracket[pg.id]["team2"] %}
                            {% if pg.bye_team_id %}
                                <p>
                                    {{ teams[pg.bye_team_id].seed }}. {{ teams[pg.bye_team_id].name
                                    }} has a bye
                                </p>
                            {% endif %}
                            {% if t1 and t2 %}
                                <div class="pick-wrapper playoff">
                                    <!-- Slot 1 -->
                                    <input type="radio" class="btn-check" name="ppick_{{ pg.id }}"
                                        id="ppick_{{ pg.id }}_1" autocomplete="off" value="{{ t1 }}" {%
                                        if user_playoff.get(pg.id) == t1 %}checked{% endif %}
                                        onchange="savePlayoffPick({{ pg.id }}, {{ t1 }})" >
                                        <label class="btn btn-outline-primary pick-btn" for="ppick_{{ pg.id }}_1">
                                            <div class="text-block">
                                                <strong>{{ teams[t1].seed }}. {{ teams[t1].name }}</strong>
                                            </div>
                                            <img src="http://a.espncdn.com/i/teamlogos/ncaa/500/{{ teams[t1].espn_id }}.png" />
                                        </label>
                                        <!-- Slot 2 -->
                                        <input type="radio" class="btn-check" name="ppick_{{ pg.id }}"
                                            id="ppick_{{ pg.id }}_2" autocomplete="off" value="{{ t2 }}" {%
                                            if user_playoff.get(pg.id) == t2 %}checked{% endif %}
                                            onchange="savePlayoffPick({{ pg.id }}, {{ t2 }})" >
                                            <label class="btn btn-outline-primary pick-btn" for="ppick_{{ pg.id }}_2">
                                                <div class="text-block">
                                                    <strong>{{ teams[t2].seed }}. {{ teams[t2].name }}</strong>
                                                </div>
                                                <img src="http://a.espncdn.com/i/teamlogos/ncaa/500/{{ teams[t2].espn_id }}.png" />
                                            </label>
                                        </div>
                                    {% else %}
                                        <p class="text-muted">Matchup TBD based on previous round</p>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                        <a href="/">
                            <button class="btn btn-primary mb-3">Congrats on making your picks! Click here to go home</button>
                        </a>
                    </div>
                {% endblock %}
